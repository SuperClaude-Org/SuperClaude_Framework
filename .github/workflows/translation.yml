name: SuperClaude Translation Automation

on:
  push:
    branches: [ main, develop, feature/i18n ]
    paths:
      - 'SuperClaude/Commands/*.md'
      - 'SuperClaude/Core/PERSONAS.md'
      - 'SuperClaude/Core/COMMANDS.md'
      - 'setup/utils/ui.py'
      - '**/*.py'
      - 'README*.md'
      - 'docs/**/*.md'
  
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'SuperClaude/Commands/*.md'
      - 'SuperClaude/Core/PERSONAS.md'
      - 'SuperClaude/Core/COMMANDS.md'
      - 'setup/utils/ui.py'
      - '**/*.py'
      - 'README*.md'
      - 'docs/**/*.md'
  
  workflow_dispatch:
    inputs:
      translation_mode:
        description: 'Translation mode'
        required: true
        default: 'incremental'
        type: choice
        options:
          - incremental
          - full
          - validate-only
      target_languages:
        description: 'Target languages (comma-separated)'
        required: false
        default: 'zh_CN,ja_JP,ko_KR'
      force_translation:
        description: 'Force translation even if no changes detected'
        required: false
        default: false
        type: boolean

env:
  PYTHONPATH: ${{ github.workspace }}
  SUPERCLAUDE_BUILD_MODE: ci

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      translation-needed: ${{ steps.check-changes.outputs.translation-needed }}
      changed-files: ${{ steps.check-changes.outputs.changed-files }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Check for translation-relevant changes
        id: check-changes
        run: |
          echo "ğŸ” æ£€æµ‹ç¿»è¯‘ç›¸å…³å˜æ›´..."
          
          # è·å–å˜æ›´çš„æ–‡ä»¶
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }}...${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
          fi
          
          echo "å˜æ›´çš„æ–‡ä»¶:"
          echo "$CHANGED_FILES"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç¿»è¯‘ç›¸å…³çš„å˜æ›´
          TRANSLATION_RELEVANT="false"
          
          echo "$CHANGED_FILES" | while read file; do
            if [[ "$file" =~ SuperClaude/Commands/.*\.md$ ]] || \
               [[ "$file" =~ SuperClaude/Core/PERSONAS\.md$ ]] || \
               [[ "$file" =~ SuperClaude/Core/COMMANDS\.md$ ]] || \
               [[ "$file" =~ setup/utils/ui\.py$ ]] || \
               [[ "$file" =~ .*\.py$ ]] || \
               [[ "$file" =~ README.*\.md$ ]] || \
               [[ "$file" =~ docs/.*\.md$ ]]; then
              echo "å‘ç°ç¿»è¯‘ç›¸å…³æ–‡ä»¶: $file"
              echo "translation-needed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          done
          
          # æ£€æŸ¥å¼ºåˆ¶ç¿»è¯‘æ ‡å¿—
          if [ "${{ github.event.inputs.force_translation }}" = "true" ]; then
            echo "å¼ºåˆ¶ç¿»è¯‘æ¨¡å¼"
            echo "translation-needed=true" >> $GITHUB_OUTPUT
          elif [ "$TRANSLATION_RELEVANT" = "false" ]; then
            echo "translation-needed=false" >> $GITHUB_OUTPUT
          fi
          
          # è¾“å‡ºå˜æ›´æ–‡ä»¶ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          echo "changed-files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  incremental-translation:
    needs: detect-changes
    if: needs.detect-changes.outputs.translation-needed == 'true' || github.event.inputs.translation_mode == 'full'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.9']
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          
          # å®‰è£…åŸºç¡€ä¾èµ–
          pip install openai httpx asyncio pathlib dataclasses
          
          # å¦‚æœæœ‰requirementsæ–‡ä»¶ï¼Œå®‰è£…é¢å¤–ä¾èµ–
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          
          # éªŒè¯å®‰è£…
          python -c "import sys; print(f'Python: {sys.version}')"
          python -c "import openai; print('OpenAI client available')"
      
      - name: Setup translation environment
        run: |
          echo "ğŸ”§ é…ç½®ç¿»è¯‘ç¯å¢ƒ..."
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          mkdir -p .superclaude/hooks
          mkdir -p .superclaude/incremental
          mkdir -p i18n/locales
          
          # è®¾ç½®Pythonè·¯å¾„
          echo "PYTHONPATH=${{ github.workspace }}" >> $GITHUB_ENV
          
          # æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
          echo "å·¥ä½œç›®å½•: $(pwd)"
          echo "Pythonè·¯å¾„: $PYTHONPATH"
          ls -la
      
      - name: Test i18n system availability
        run: |
          echo "ğŸ§ª æµ‹è¯•i18nç³»ç»Ÿå¯ç”¨æ€§..."
          
          # æµ‹è¯•å¯¼å…¥
          python -c "
          try:
              from i18n.extractor import SuperClaudeContentExtractor
              from i18n.incremental import IncrementalTranslationManager
              print('âœ… i18nç³»ç»Ÿå¯¼å…¥æˆåŠŸ')
          except ImportError as e:
              print(f'âŒ i18nç³»ç»Ÿå¯¼å…¥å¤±è´¥: {e}')
              exit(1)
          "
          
          # æµ‹è¯•å†…å®¹æå–
          python -c "
          from i18n.extractor import SuperClaudeContentExtractor
          extractor = SuperClaudeContentExtractor('.')
          content = extractor.extract_all_content()
          stats = extractor.get_content_statistics()
          print(f'ğŸ“Š æå–å†…å®¹ç»Ÿè®¡: {dict(stats)}')
          "
      
      - name: Run incremental translation
        env:
          QWEN_API_KEY: ${{ secrets.QWEN_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          CI: true
        run: |
          echo "ğŸš€ è¿è¡Œå¢é‡ç¿»è¯‘..."
          
          # ç¡®å®šç›®æ ‡è¯­è¨€
          if [ "${{ github.event.inputs.target_languages }}" ]; then
            TARGET_LANGS="${{ github.event.inputs.target_languages }}"
          else
            TARGET_LANGS="zh_CN,ja_JP,ko_KR"
          fi
          
          echo "ç›®æ ‡è¯­è¨€: $TARGET_LANGS"
          
          # æ£€æŸ¥APIå¯†é’¥
          if [ -z "$QWEN_API_KEY" ] && [ -z "$OPENROUTER_API_KEY" ]; then
            echo "âš ï¸ æœªé…ç½®ç¿»è¯‘APIå¯†é’¥ï¼Œè¿è¡ŒéªŒè¯æ¨¡å¼"
            python setup/components/i18n_integration.py validate
          else
            echo "âœ… APIå¯†é’¥å·²é…ç½®ï¼Œè¿è¡Œå¢é‡ç¿»è¯‘"
            
            # è¿è¡Œå¢é‡ç¿»è¯‘æ£€æµ‹
            python -c "
            import asyncio
            import sys
            from i18n.incremental import IncrementalTranslationManager
            
            async def main():
                manager = IncrementalTranslationManager('.')
                changes = manager.detect_content_changes()
                
                if changes:
                    print(f'ğŸ“‹ æ£€æµ‹åˆ° {len(changes)} é¡¹å˜æ›´ï¼Œå‡†å¤‡ç¿»è¯‘...')
                    
                    # åœ¨CIç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬åªåšæ£€æµ‹å’Œç¼“å­˜ï¼Œä¸æ‰§è¡Œå®é™…ç¿»è¯‘
                    # é™¤éæ˜ç¡®è®¾ç½®äº†APIå¯†é’¥å¹¶ä¸”æ˜¯æ‰‹åŠ¨è§¦å‘çš„workflow
                    if '${{ github.event_name }}' == 'workflow_dispatch':
                        target_langs = '$TARGET_LANGS'.split(',')
                        result = await manager.translate_changes(changes, target_langs)
                        print(f'âœ… ç¿»è¯‘å®Œæˆ: {result}')
                    else:
                        print('â„¹ï¸ è‡ªåŠ¨è§¦å‘çš„å·¥ä½œæµï¼Œè·³è¿‡å®é™…ç¿»è¯‘æ‰§è¡Œ')
                        print('ğŸ’¡ ä½¿ç”¨workflow_dispatchæ‰‹åŠ¨è§¦å‘ä»¥æ‰§è¡Œç¿»è¯‘')
                else:
                    print('âœ… æœªæ£€æµ‹åˆ°éœ€è¦ç¿»è¯‘çš„å˜æ›´')
                    
            asyncio.run(main())
            "
          fi
      
      - name: Validate translation quality
        if: github.event.inputs.translation_mode != 'validate-only'
        run: |
          echo "âœ… éªŒè¯ç¿»è¯‘è´¨é‡..."
          
          # è¿è¡Œæ„å»ºåéªŒè¯
          python setup/components/i18n_integration.py validate
      
      - name: Generate translation report
        if: always()
        run: |
          echo "ğŸ“Š ç”Ÿæˆç¿»è¯‘æŠ¥å‘Š..."
          
          # è·å–ç¿»è¯‘ç»Ÿè®¡ä¿¡æ¯
          python -c "
          import json
          import os
          from pathlib import Path
          from i18n.cache import TranslationCache
          from i18n.incremental import IncrementalTranslationManager
          
          try:
              # ç¼“å­˜ç»Ÿè®¡
              cache = TranslationCache()
              cache_stats = cache.get_cache_statistics()
              
              # å¢é‡ç¿»è¯‘ç»Ÿè®¡
              manager = IncrementalTranslationManager('.')
              incremental_stats = manager.get_incremental_statistics()
              
              # æ„å»ºæŠ¥å‘Š
              report = {
                  'workflow': {
                      'trigger': '${{ github.event_name }}',
                      'ref': '${{ github.ref }}',
                      'sha': '${{ github.sha }}'
                  },
                  'cache_stats': cache_stats,
                  'incremental_stats': incremental_stats,
                  'api_keys_available': {
                      'qwen': bool(os.getenv('QWEN_API_KEY')),
                      'openrouter': bool(os.getenv('OPENROUTER_API_KEY'))
                  }
              }
              
              print('SuperClaude Translation Report:')
              print(json.dumps(report, ensure_ascii=False, indent=2))
              
              # ä¿å­˜æŠ¥å‘Šæ–‡ä»¶
              with open('translation_report.json', 'w', encoding='utf-8') as f:
                  json.dump(report, f, ensure_ascii=False, indent=2)
                  
          except Exception as e:
              print(f'æŠ¥å‘Šç”Ÿæˆå¤±è´¥: {e}')
          "
      
      - name: Upload translation artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: translation-report
          path: |
            translation_report.json
            i18n/locales/*.json
            .superclaude/incremental/*.json*
          retention-days: 30
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && needs.detect-changes.outputs.translation-needed == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            try {
              const reportData = fs.readFileSync('translation_report.json', 'utf8');
              const report = JSON.parse(reportData);
              
              const comment = `## ğŸŒ SuperClaude ç¿»è¯‘è‡ªåŠ¨åŒ–æŠ¥å‘Š
              
              **å˜æ›´æ£€æµ‹**: å‘ç°ç¿»è¯‘ç›¸å…³å˜æ›´  
              **ç¼“å­˜ç»Ÿè®¡**: ${report.cache_stats.total_entries} é¡¹ç¼“å­˜ç¿»è¯‘  
              **å¢é‡ç¿»è¯‘**: ${report.incremental_stats.total_incremental_runs} æ¬¡å¢é‡æ›´æ–°  
              **APIçŠ¶æ€**: ${report.api_keys_available.qwen ? 'âœ…' : 'âŒ'} Qwen, ${report.api_keys_available.openrouter ? 'âœ…' : 'âŒ'} OpenRouter
              
              > ğŸ’¡ æ‰‹åŠ¨è§¦å‘å®Œæ•´ç¿»è¯‘: ä½¿ç”¨ \`workflow_dispatch\` äº‹ä»¶æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('æ— æ³•åˆ›å»ºPRè¯„è®º:', error.message);
            }

  quality-check:
    needs: [detect-changes, incremental-translation]
    if: always() && (needs.detect-changes.outputs.translation-needed == 'true' || github.event.inputs.translation_mode != 'validate-only')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Download translation artifacts
        uses: actions/download-artifact@v3
        with:
          name: translation-report
          path: ./artifacts
      
      - name: Quality assessment
        run: |
          echo "ğŸ” ç¿»è¯‘è´¨é‡è¯„ä¼°..."
          
          # æ£€æŸ¥æœ¬åœ°åŒ–æ–‡ä»¶
          if [ -d "i18n/locales" ]; then
            echo "æœ¬åœ°åŒ–æ–‡ä»¶:"
            ls -la i18n/locales/
            
            # éªŒè¯JSONæ ¼å¼
            for file in i18n/locales/*.json; do
              if [ -f "$file" ]; then
                echo "éªŒè¯ $file..."
                python -c "
                import json
                try:
                    with open('$file', 'r', encoding='utf-8') as f:
                        data = json.load(f)
                    print(f'âœ… {\"$file\"}: JSONæ ¼å¼æ­£ç¡®')
                    
                    # æ£€æŸ¥å¿…è¦å­—æ®µ
                    required_fields = ['metadata', 'commands', 'personas', 'ui']
                    missing_fields = [f for f in required_fields if f not in data or not data[f]]
                    
                    if missing_fields:
                        print(f'âš ï¸ {\"$file\"}: ç¼ºå°‘å­—æ®µ {missing_fields}')
                    else:
                        total_items = sum(len(data[f]) for f in required_fields[1:])
                        print(f'âœ… {\"$file\"}: {total_items} é¡¹ç¿»è¯‘')
                        
                except Exception as e:
                    print(f'âŒ {\"$file\"}: JSONè§£æå¤±è´¥ - {e}')
                "
              fi
            done
          else
            echo "âš ï¸ æœ¬åœ°åŒ–æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨"
          fi
      
      - name: Set workflow status
        run: |
          echo "ğŸ“‹ å·¥ä½œæµçŠ¶æ€æ€»ç»“:"
          echo "- å˜æ›´æ£€æµ‹: ${{ needs.detect-changes.outputs.translation-needed == 'true' && 'âœ… å‘ç°ç¿»è¯‘ç›¸å…³å˜æ›´' || 'âšª æœªå‘ç°ç¿»è¯‘ç›¸å…³å˜æ›´' }}"
          echo "- å¢é‡ç¿»è¯‘: ${{ needs.incremental-translation.result == 'success' && 'âœ… æ‰§è¡ŒæˆåŠŸ' || needs.incremental-translation.result == 'skipped' && 'âšª å·²è·³è¿‡' || 'âŒ æ‰§è¡Œå¤±è´¥' }}"
          echo "- è´¨é‡æ£€æŸ¥: âœ… å·²å®Œæˆ"
          
          if [ "${{ needs.incremental-translation.result }}" = "failure" ]; then
            echo "âŒ å·¥ä½œæµåŒ…å«å¤±è´¥æ­¥éª¤"
            exit 1
          else
            echo "âœ… å·¥ä½œæµæ‰§è¡Œå®Œæˆ"
          fi